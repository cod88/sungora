// Контроллер главной страницы
package api

import (
	"strconv"

	"zzzzzzzzz/config"
	"zzzzzzzzz/models"

	"gopkg.in/sungora/app.v1/core"
)

type ControlModel struct {
	core.ControllerJson
}

func NewControlModel() core.ControllerFace {
	return new(ControlModel)
}

// GET действие по умолчанию
func (self *ControlModel) GET() {
	// сессия
	var count int
	if self.Session.Get("count") != nil {
		count, _ = self.Session.Get("count").(int)
	}
	count += 1
	self.Session.Set("count", count)

	// работа с моделью
	u := models.NewUser(0)
	if "" != core.Config.Main.DriverDB {
		core.DB.AutoMigrate(u)

	}
	u.InvoiceIDSet(1234)
	u.NamSet("Вася Пупкин")
	u.Age = count

	self.Data = u
	return
}

// POST работа с моделью создание
func (self *ControlModel) POST() {
	u := models.NewUser(0)
	u.InvoiceIDSet(8697)
	u.NamSet("Вася пупкин")
	u.Age = 67
	u.SampleJsonSet(`{"ServiceID": 24,"ClientID": 24,"InvoiceID": 24,"BillingCode": "NL","LocationCode": "NL"}`)
	u.Save()

	self.Data = u
	return
}

// PUT работа с моделью изменение
func (self *ControlModel) PUT() {
	u := models.NewUser(0)
	self.RW.RequestBodyDecodeJson(u)
	u.Save()

	self.Data = u
	return
}

// DELETE работа с моделью удаление
func (self *ControlModel) DELETE() {
	var ID uint64
	ID, _ = strconv.ParseUint(self.RW.RequestParams["userID"][0], 10, 64)
	u := models.NewUser(ID)
	u.Delete()

	self.Data = u
	return
}

// OPTIONS получение различных опций для текущего контроллера
func (self *ControlModel) OPTIONS() {
	// сценарии для виджетов
	u := models.NewUserCustom()

	// Выводимые данные
	self.Data = map[string]interface{}{
		"scenario form": u.Scenario.AdminForm,
		"config access": config.ServiceAccess,
	}
	return
}
